apiVersion: batch/v1
kind: CronJob
metadata:
  name: rpa-index-deployment
  namespace: geoserver
spec:
  schedule: "0 2 * * *"
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: Never
          containers:
          - name: rpa-index
            image: {{ .Values.dataIngestion.rpaData }}
            env:
            - name: URL
              value: {{ template "geoserver.fullname" . }}/data-services
            - name: WORKSPACE
              value: {{ .Values.dataIngestion.workspace }}
            - name: DATASTORE
              value: {{ .Values.dataIngestion.datastore }}
            - name: DATA_DIR
              value: {{ .Values.dataIngestion.dataDir }}
            - name: BLOB_DIR
              value: {{ .Values.dataIngestion.blobDir }}
            - name: GEOSERVER_ADMIN_USER
              valueFrom:
                secretKeyRef:
                  name: {{ template "geoserver.secretName" . }}
                  key: geoserver-user
            - name: GEOSERVER_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ template "geoserver.secretName" . }}
                  key: geoserver-password    
            volumeMounts:
              - name: blob01
                mountPath: {{ .Values.dataIngestion.blobDir }}
              - name: geoserver-data-dir
                mountPath: {{ .Values.dataIngestion.dataDir }}
                subPath: {{ .Values.persistence.geoserverDataDir.subPath }}
          volumes:
            - name: blob01
              persistentVolumeClaim:
                claimName: {{ template "geoserver.fullname" . }}-rpa-blob
{{- if and .Values.persistence.geoserverDataDir.enabled .Values.persistence.geoserverDataDir.existingClaim }}
            - name: geoserver-data-dir
              persistentVolumeClaim:
{{- with .Values.persistence.geoserverDataDir.existingClaim }}
                claimName: {{ tpl . $ }}
{{- end }}
{{- else if .Values.persistence.geoserverDataDir.enabled }}
            - name: geoserver-data-dir
              persistentVolumeClaim:
                claimName: {{ template "geoserver.fullname" . }}-geoserver-data-dir
{{- else if not .Values.persistence.geoserverDataDir.enabled }}
            - name: geoserver-data-dir
              emptyDir: {}
{{- end }}
